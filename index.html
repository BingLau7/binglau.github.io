<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="村里最好的博客" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="Res severa est verum gaudium.">
<meta property="og:type" content="website">
<meta property="og:title" content="村里最好的博客">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="村里最好的博客">
<meta property="og:description" content="Res severa est verum gaudium.">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="村里最好的博客">
<meta name="twitter:description" content="Res severa est verum gaudium.">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>村里最好的博客</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">村里最好的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/12/ByteBuffer-源码剖析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘冰鉴">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://github.com/BingLau7/blog/blob/master/images/drunktocat.jpg?raw=true">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="村里最好的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/12/ByteBuffer-源码剖析/" itemprop="url">ByteBuffer 源码剖析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-12T17:11:18+08:00">
                2019-01-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/源码分析/" itemprop="url" rel="index">
                    <span itemprop="name">源码分析</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>要点:</p>
<ol>
<li>JDK 原生支持，主要用于 NIO</li>
<li>包含两个实现<ol>
<li>HeapByteBuffer: 基于 Java 堆实现</li>
<li>DirectByteBuffer: 使用 unsafe 的 API 进行堆外操作</li>
</ol>
</li>
<li>核心方法为 <code>put(byte)</code> 与 <code>get()</code>。分别是往ByteBuffer里写一个字节，和读一个字节。</li>
<li>读写模式分离，正常的应用场景是：往ByteBuffer里写一些数据，然后 <code>flip()</code>，然后再读出来。</li>
<li>在 JDK11 中 MappedByteBuffer 的创建实际是 DirectByteBuffer</li>
<li>DirectByteBuffer 的垃圾回收利用了幻象引用进行回收，详见下面的 <code>Cleaner</code></li>
</ol>
<h3 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// write</span></span><br><span class="line">    ByteBuffer buffer = ByteBuffer.allocate(<span class="number">8</span>);</span><br><span class="line">    System.out.printf(<span class="string">"before pos/cap/limit: %d, %d, %d\n"</span>, buffer.position(), buffer.capacity(), buffer.limit());</span><br><span class="line">    <span class="comment">// before pos/cap/limit: 0, 8, 8</span></span><br><span class="line"></span><br><span class="line">    buffer.putShort((<span class="keyword">short</span>)<span class="number">20</span>);</span><br><span class="line">    buffer.put(<span class="string">"test"</span>.getBytes());</span><br><span class="line">    System.out.printf(<span class="string">"write pos/cap/limit: %d, %d, %d\n"</span>, buffer.position(), buffer.capacity(), buffer.limit());</span><br><span class="line">    <span class="comment">// write pos/cap/limit: 6, 8, 8</span></span><br><span class="line"></span><br><span class="line">    buffer.flip();</span><br><span class="line">    System.out.printf(<span class="string">"flip pos/cap/limit: %d, %d, %d\n"</span>, buffer.position(), buffer.capacity(), buffer.limit());</span><br><span class="line">    <span class="comment">// flip pos/cap/limit: 0, 8, 6</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">short</span> num = buffer.getShort();</span><br><span class="line">    System.out.printf(<span class="string">"get short pos/cap/limit: %d, %d, %d\n"</span>, buffer.position(), buffer.capacity(), buffer.limit());</span><br><span class="line">    <span class="comment">// get short pos/cap/limit: 2, 8, 6</span></span><br><span class="line">    <span class="keyword">byte</span>[] strArr = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span>];</span><br><span class="line">    buffer.get(strArr, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">    System.out.printf(<span class="string">"get array pos/cap/limit: %d, %d, %d\n"</span>, buffer.position(), buffer.capacity(), buffer.limit());</span><br><span class="line">    <span class="comment">// get array pos/cap/limit: 6, 8, 6</span></span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">"num: "</span> + num + <span class="string">" str: "</span> + <span class="keyword">new</span> String(strArr));</span><br><span class="line">    <span class="comment">// num: 20 str: test</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="主要工作原理"><a href="#主要工作原理" class="headerlink" title="主要工作原理"></a>主要工作原理</h3><p><strong>内部字段</strong></p>
<ul>
<li><code>byte[] hb</code>: 缓存数组</li>
<li><code>position</code>: 当前操作位置</li>
<li><code>capacity</code>: 初始化 Buffer 容量</li>
<li><code>limit</code>: 读写的上限，limit &lt;= capacity</li>
<li><code>mark</code>: 为某一读过的位置做标记，便于某些时候回退到该位置。</li>
</ul>
<p>主要操作即操作这几个字段用于协同</p>
<ol>
<li><code>put/get</code> 将会增加 <code>position</code>，其操作也是从 <code>position</code> 开始</li>
<li><code>put</code> 将会增加 <code>limit</code>，检测 <code>capacity</code></li>
<li><code>get</code> 将会检测 <code>limit</code></li>
<li><code>filp</code> 将会复位 <code>position</code> 一般用于读写转换</li>
</ol>
<h3 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h3><h4 id="HeapByteBuffer-解析"><a href="#HeapByteBuffer-解析" class="headerlink" title="HeapByteBuffer 解析"></a>HeapByteBuffer 解析</h4><h5 id="init"><a href="#init" class="headerlink" title="init"></a>init</h5><p>就 ByteBuffer 来看，<code>HeapByteBuffer</code> 中初始化链条<strong>第一环</strong>是 Buffer 的构造器，代码过于简单不进行说明，总体来说是初始化了 <code>capacity、limit、position、mark</code>。<br>这里大家会疑惑 <code>capacity</code> 可能通过 <code>allocate</code> 传递了，但其他的从哪儿来？  </p>
<ol>
<li>limit = capacity</li>
<li>mark = -1 会在构造器中直接置为 0 </li>
<li>position = 0</li>
</ol>
<p><strong>第二环:</strong> ByteBuffer 的构造器会将 byte[] 初始化并设置 capacity，同时设置 offset = 0.</p>
<h5 id="put"><a href="#put" class="headerlink" title="put"></a>put</h5><p>核心函数：</p>
<ul>
<li><code>public ByteBuffer put(byte[] src, int offset, int length)</code>  </li>
<li><code>public final Buffer position(int newPosition)</code>  </li>
</ul>
<p>要点:</p>
<ol>
<li><code>checkBounds</code> 是个有趣的函数，若其中（offset、length、src.length）任一一个值为负数则结果即超出，若 <code>(size - (off + len))</code> 为负则结果也为异常。其实现使用了 <code>|</code></li>
<li>position 将会重新设置位置，这里面，若 mark 的值大于 postition 了 mark 会重置为 -1</li>
<li>若对比 <code>ByteBuffer</code> 父类与 <code>HeapByteBuffer</code> 的实现来看会发现，<code>ByteBuffer</code> 使用 <code>put(byte)</code> 逐个工作而后者则借助了 <code>System.arrayCopy</code></li>
</ol>
<p>既然都看到这儿了，那我们就了解一下 <code>System.arrayCopy</code>，native 源码翻起来</p>
<p>该代码位于 <code>src/share/native/lang/System.c</code> 中，主要通过 <code>Java_java_lang_System_registerNatives</code> 注册，其真实实现在 <code>src/share/vm/prims/jvm.cpp</code></p>
<p>说实话，得补一下 C艹…</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">JVM_ENTRY(<span class="keyword">void</span>, JVM_ArrayCopy(JNIEnv *env, jclass ignored, jobject src, jint src_pos,</span><br><span class="line">                               jobject dst, jint dst_pos, jint length))</span><br><span class="line">  JVMWrapper(<span class="string">"JVM_ArrayCopy"</span>);</span><br><span class="line">  <span class="comment">// Check if we have null pointers</span></span><br><span class="line">  <span class="keyword">if</span> (src == <span class="literal">NULL</span> || dst == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    THROW(vmSymbols::java_lang_NullPointerException());</span><br><span class="line">  &#125;</span><br><span class="line">  arrayOop s = arrayOop(JNIHandles::resolve_non_null(src));</span><br><span class="line">  arrayOop d = arrayOop(JNIHandles::resolve_non_null(dst));</span><br><span class="line">  assert(s-&gt;is_oop(), <span class="string">"JVM_ArrayCopy: src not an oop"</span>);</span><br><span class="line">  assert(d-&gt;is_oop(), <span class="string">"JVM_ArrayCopy: dst not an oop"</span>);</span><br><span class="line">  <span class="comment">// Do copy</span></span><br><span class="line">  s-&gt;klass()-&gt;copy_array(s, src_pos, d, dst_pos, length, thread);</span><br><span class="line">JVM_END</span><br></pre></td></tr></table></figure>
<p>可以看出，主要逻辑肯定是 <code>copy_array</code> 中（这里可能涉及到 <code>TypeArrayKlass（基础类型）/ObjArrayKlass</code>，我们看前者）</p>
<p>核心逻辑：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="comment">// This is an attempt to make the copy_array fast.</span></span><br><span class="line"><span class="keyword">int</span> l2es = log2_element_size();</span><br><span class="line"><span class="keyword">int</span> ihs = array_header_in_bytes() / wordSize;</span><br><span class="line"><span class="keyword">char</span>* src = (<span class="keyword">char</span>*) ((oop*)s + ihs) + ((<span class="keyword">size_t</span>)src_pos &lt;&lt; l2es);</span><br><span class="line"><span class="keyword">char</span>* dst = (<span class="keyword">char</span>*) ((oop*)d + ihs) + ((<span class="keyword">size_t</span>)dst_pos &lt;&lt; l2es);</span><br><span class="line">Copy::conjoint_memory_atomic(src, dst, (<span class="keyword">size_t</span>)length &lt;&lt; l2es);</span><br></pre></td></tr></table></figure></p>
<p>最后会发现调用了平台相关的 <code>pd_conjoint_bytes</code>，看了看 linux 下面的实现居然都直接汇编了，卧槽… 追到这儿暂停吧，真看不懂了[捂脸]</p>
<p>但到现在也差不多已知猜测是通过操作整块内存一起使用指针串联提高执行速度的。</p>
<h5 id="get"><a href="#get" class="headerlink" title="get"></a>get</h5><p>get 流程与 put 几乎一致。即空数组作为 arrayCopy 的 dst，然后将 dst 作为结果返回。</p>
<h4 id="MappedByteBuffer-解析"><a href="#MappedByteBuffer-解析" class="headerlink" title="MappedByteBuffer 解析"></a>MappedByteBuffer 解析</h4><p>由于 DirectByteBuffer 继承了 MappedByteBuffer 且个人对其机制比较感兴趣，所以先介绍一下 MappedByteBuffer。这儿有一篇文章可以参考一下: <a href="https://www.jianshu.com/p/f90866dcbffc" target="_blank" rel="noopener">深入浅出MappedByteBuffer</a>。文章要点:</p>
<ol>
<li>MappedByteBuffer 继承自 ByteBuffer，内部维护了一个逻辑地址 address。</li>
<li>除了正常 READ/WRITE 还支持 copy_on_write（MapMode.PRIVATE）</li>
<li>解析了 MappedByteBuffer 的创建过程</li>
</ol>
<p>文中所包含的代码可以在 <a href="https://github.com/AdoptOpenJDK/openjdk-jdk11/blob/master/src/java.base/share/classes/sun/nio/ch/FileChannelImpl.java" target="_blank" rel="noopener">FileChannelImpl.java</a> 查看</p>
<p>创建主要核心代码 <code>Utils.newMappedByteBuffer</code> 主要是创建了一个 <code>DirectByteBuffer</code> （失望了吧？）</p>
<h4 id="DirectByteBuffer-解析"><a href="#DirectByteBuffer-解析" class="headerlink" title="DirectByteBuffer 解析"></a>DirectByteBuffer 解析</h4><p>即堆外内存。关于介绍这里有篇文章可以参考一下 <a href="http://www.importnew.com/26334.html" target="_blank" rel="noopener">堆外内存之 DirectByteBuffer 详解</a>。文章要点:</p>
<ol>
<li>DirectByteBuffer 该类本身还是位于Java内存模型的堆中。堆内内存是 JVM 可以直接管控、操纵。而 DirectByteBuffer 中的 <code>unsafe.allocateMemory(size);</code> 是个一个 native 方法，这个方法分配的是堆外内存，通过 C 的 malloc 来进行分配的。分配的内存是系统本地的内存，并不在 Java 的内存中，也不属于 JVM 管控范围。</li>
<li>DirectByteBuffer 中的 <code>address</code> 表示分配的堆外内存地址。</li>
<li>利用 PhantomReference 跟踪垃圾回收过程</li>
<li>最后介绍了一些 DirectByteBuffer 使用的要点</li>
</ol>
<p>还有笨神的文章<a href="http://lovestblog.cn/blog/2015/05/12/direct-buffer/" target="_blank" rel="noopener">JVM源码分析之堆外内存完全解读</a>。文章要点:</p>
<ol>
<li>区分广义堆外内存（jvm 本身在运行过程中分配的内存，codecache，jni 里分配的内存，DirectByteBuffer 分配的内存等等），狭义堆外内存（DirectByteBuffer）</li>
<li><code>Bits.reserveMemory</code> 用以分配内存</li>
<li>默认堆外内存实际是在 java.lang.System 初始化时候通过 native 方法 <code>Runtime.getRuntime().maxMemory()</code> 设置的（若不设置 <code>-Dsun.nio.MaxDirectMemorySize</code>）。</li>
<li><code>Bits.reserveMemory</code> 过程中主动触发了一次 <code>System.gc()</code> 。堆外内存不会对 gc 造成什么影响(这里的 System.gc 除外)，但是堆外内存的回收其实依赖于我们的 gc 机制，gc 能通过操作 DirectByteBuffer 对象来间接操作对应的堆外内存了。</li>
<li>DirectByteBuffer 对象在创建的时候关联了一个 PhantomReference，其主要是用来跟踪对象何时被回收的，它不能影响 gc 决策，但是 gc 过程中如果发现某个对象除了只有 PhantomReference 引用它之外，并没有其他的地方引用它了，那将会把这个引用放到 java.lang.ref.Reference.pending 队列里，在 gc 完毕的时候通知 ReferenceHandler 这个守护线程去执行一些后置处理，而 DirectByteBuffer 关联的 PhantomReference 是 PhantomReference 的一个子类，在最终的处理里会通过 Unsafe 的 free 接口来释放 DirectByteBuffer 对应的堆外内存块。</li>
<li>在通信阶段存在于 Heap 的内存最后都要 copy 一份到堆外，这样直接使用堆外更好</li>
<li>堆外内存不会对 gc 造成影响，同时也不受 gc 影响</li>
<li>对于需要频繁操作的内存，并且仅仅是临时存在一会的，都建议使用堆外内存，并且做成缓冲池，不断循环利用这块内存。</li>
<li>堆外内存的回收不是被直接控制的，当然你可以通过别的一些途径，比如反射，直接使用 Unsafe 接口等，但是这些务必给你带来了一些烦恼。如果大面积使用迟早会发生内存泄露。</li>
</ol>
<p>两篇文章都讲得足够好了，就不赘述了。</p>
<h5 id="Cleaner-详解"><a href="#Cleaner-详解" class="headerlink" title="Cleaner 详解"></a>Cleaner 详解</h5><p>先简单介绍一下 PhantomReference，所谓幻象引用。</p>
<ol>
<li>不能通过该引用去访问对象</li>
<li>提供一种确保对象被 <code>finalize</code> 后做某些事的机制</li>
<li>一般使用幻想应用模式：<ol>
<li>指定一个 ReferenceQueue 作为引用队列</li>
<li>当 finalize(非空实现)被触发时，JVM 会将对象推入引用队列中</li>
</ol>
</li>
</ol>
<p><strong>PhantomReference Demo</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PhantomReferenceTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ReferenceQueue rq = <span class="keyword">new</span> ReferenceQueue();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        Object t = <span class="keyword">new</span> Object();</span><br><span class="line">        PhantomReference pr = <span class="keyword">new</span> PhantomReference(t, rq);</span><br><span class="line">        t = <span class="keyword">null</span>;</span><br><span class="line">        System.gc();</span><br><span class="line">        System.out.println(<span class="string">"finalize: "</span> + (rq.remove(<span class="number">1000</span>) != <span class="keyword">null</span>)); <span class="comment">// finalize: true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个符合预期，但是若对象实现了 <code>finalizer</code> 就比较有意思了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PhantomReferenceTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ReferenceQueue rq = <span class="keyword">new</span> ReferenceQueue();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TestDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finalize</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"test"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        TestDemo t = <span class="keyword">new</span> TestDemo();</span><br><span class="line">        PhantomReference pr = <span class="keyword">new</span> PhantomReference(t, rq);</span><br><span class="line">        t = <span class="keyword">null</span>;</span><br><span class="line">        System.gc();</span><br><span class="line">        Thread.sleep(<span class="number">100</span>);</span><br><span class="line">        System.out.println(<span class="string">"finalize: "</span> + (rq.remove(<span class="number">1000</span>) != <span class="keyword">null</span>)); <span class="comment">// finalize: false</span></span><br><span class="line">        System.gc();</span><br><span class="line">        System.out.println(<span class="string">"finalize: "</span> + (rq.remove(<span class="number">1000</span>) != <span class="keyword">null</span>)); <span class="comment">// finalize: true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以下引用以下 《深入理解 Java 虚拟机》 书中内容</p>
<blockquote>
<p>即使在可达性分析算法中不可达的对象，也并非是『非死不可』的，这时候它们暂时处于『缓刑』阶段，要真正宣告一个对象死亡，至少要经历两次标记过程：如果对象在进行可达性分析后发现没有与 GC Roots 相连接的引用链，那它将会被第一次标记并进行一次筛选，筛选的条件是此对象是否有必要执行 <code>finalize()</code> 方法。<strong>当对象没有覆盖 <code>finalizer()</code> 方法，或者 <code>finalizer()</code> 方法已经被虚拟机调用过，虚拟机将这两种情况都视为『没有必要执行』。</strong></p>
</blockquote>
<p>即上述之所以需要第二次 gc 才能触发引用队列的原因是对象在第一次时并未真正的死亡。</p>
<p>接下来是 Cleaner 的源码，其核心即是 <code>public class Cleaner extends PhantomReference&lt;Object&gt;</code></p>
<p>其中 <code>clean()</code> 方法是核心清理代码，这里是在 <code>java.lang.ref.Reference</code> 初始化时创建了一个 <code>ReferenceHandler</code> 的守护线程进行调用。</p>
<p>而其调用的清理任务是来自于 DirectByteBuffer 的 Deallocator Runnable。主要记录了 <code>address</code> 内存地址信息，以及内存容量信息，然后使用 <code>unsafe.freeMemory(address)</code> 释放该内存地址，最后再调用 <code>Bits.unreserveMemory</code> 来清理内存计数。 </p>
<p>关于 Cleaner 与 finalizer 最新的还有下面这些可以参考:</p>
<p><a href="https://bugs.openjdk.java.net/browse/JDK-8165641" target="_blank" rel="noopener">Deprecate Object.finalize</a><br><a href="https://bugs.openjdk.java.net/browse/JDK-8138696" target="_blank" rel="noopener">java.lang.ref.Cleaner - an alternative to finalization</a><br><a href="http://mail.openjdk.java.net/pipermail/core-libs-dev/2017-March/046650.html" target="_blank" rel="noopener">RFR 9: 8165641 : Deprecate Object.finalize</a></p>
<h3 id="ByteBuffer-与-ByteBuf"><a href="#ByteBuffer-与-ByteBuf" class="headerlink" title="ByteBuffer 与 ByteBuf"></a>ByteBuffer 与 ByteBuf</h3><p>Netty 中的 ByteBuf 是由于 ByteBuffer 在使用上的困难，以及一些在网络 IO 上的常用操作的缺失决定了其存在性。</p>
<p>其特性参考 <a href="https://netty.io/4.1/api/index.html" target="_blank" rel="noopener">官方 API</a></p>
<ol>
<li>可自定义 buffer type</li>
<li>composite buffer type 可以实现零拷贝</li>
<li>动态长度 Buffer type</li>
<li>不需要调用 filp() 在读写模式下转换</li>
<li>通常比 ByteBuffer 快</li>
</ol>
<p>接下来的文章，我们将深入 ByteBuf 源码进行分析。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/30/关于-asyncio-的喃喃自语/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘冰鉴">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://github.com/BingLau7/blog/blob/master/images/drunktocat.jpg?raw=true">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="村里最好的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/30/关于-asyncio-的喃喃自语/" itemprop="url">关于 asyncio 的喃喃自语</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-30T00:22:04+08:00">
                2018-01-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/工具/" itemprop="url" rel="index">
                    <span itemprop="name">工具</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>大多数东西都是根据之前学习中的印象而来，这篇文章更多的是喃喃自语吧。</p>
<h3 id="协程"><a href="#协程" class="headerlink" title="协程"></a>协程</h3><p>在 Python 3.5 之前，协程在我眼中应该就是 <code>yield</code> 这个语法的同义，通过 <code>send</code>、<code>throw</code> 等方法来作为其交互，用于多进程中以提升效率，然而就 Python 的使用环境来说，其实接触到的机会并不是太多。</p>
<p>在 Python 3.5 之后，给了一种新的，现在看起来还是比较友好的选择</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"Hello world!"</span>)</span><br><span class="line">    <span class="comment"># asyncio.sleep 也是一个 coroutine</span></span><br><span class="line">    <span class="comment"># 异步调用asyncio.sleep(1):</span></span><br><span class="line">    <span class="comment"># 线程也可以从这儿拿到返回值（asyncio.sleep(1) 返回值为 None）</span></span><br><span class="line">    r = <span class="keyword">await</span> asyncio.sleep(<span class="number">1</span>)</span><br><span class="line">    print(<span class="string">"Hello again!"</span>)</span><br></pre></td></tr></table></figure>
<p>在 <code>I/O</code> 密集的地方，填入 <code>await</code> ，在 <code>def</code> 前面加上 <code>async</code>，不需要去适应至今让我还是十分不适的 <code>yield</code> / <code>yield from</code> </p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2018/01/30/关于-asyncio-的喃喃自语/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/24/Kafka生产者分析——RecordAccumulator/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘冰鉴">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://github.com/BingLau7/blog/blob/master/images/drunktocat.jpg?raw=true">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="村里最好的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/24/Kafka生产者分析——RecordAccumulator/" itemprop="url">Kafka生产者分析——RecordAccumulator</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-24T19:38:31+08:00">
                2017-12-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/源码分析/" itemprop="url" rel="index">
                    <span itemprop="name">源码分析</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <blockquote>
<p> 紧接 <a href="https://binglau7.github.io/2017/12/18/Kafka%E7%94%9F%E4%BA%A7%E8%80%85%E5%88%86%E6%9E%90%E2%80%94%E2%80%94KafkaProducer/" target="_blank" rel="noopener">Kafka生产者分析——KafkaProducer</a></p>
</blockquote>
<p>前文介绍过，KafkaProducer 可以有同步和异步两种方式发送消息，其实两者的底层实现相同，都是通过异步方式实现的。主线程调用 <code>KafkaProducer#send()</code> 方法发送消息的时候，先将消息放到 <code>RecordAccumulator</code> 中暂存，然后主线程就可以从 <code>send()</code> 方法中返回了，此时消息并没有真正地发送给 Kafka，而是缓存在了 <code>RecordAccumulator</code> 中。之后，业务线程<strong>通过 <code>KafkaProducer#send()</code> 方法不断向 <code>RecordAccumulator</code> 追加消息，当达到一定的条件，会唤醒 <code>Sender</code> 线程发送 <code>RecordAccumulator</code> 中的消息。</strong></p>
<p>下面我们就来介绍 <code>RecordAccumulator</code> 的结构。首先需要注意的是，<strong><code>RecordAccumulator</code> 至少有一个业务线程和一个 <code>Sender</code> 线程并发操作，所以必须是线程安全的</strong>。</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/12/24/Kafka生产者分析——RecordAccumulator/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/18/Spring源码分析-AOP/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘冰鉴">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://github.com/BingLau7/blog/blob/master/images/drunktocat.jpg?raw=true">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="村里最好的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/18/Spring源码分析-AOP/" itemprop="url">Spring源码分析-AOP</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-18T22:28:01+08:00">
                2017-12-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/源码分析/" itemprop="url" rel="index">
                    <span itemprop="name">源码分析</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="动态-AOP-使用示例"><a href="#动态-AOP-使用示例" class="headerlink" title="动态 AOP 使用示例"></a>动态 AOP 使用示例</h2><ol>
<li><p>创建用于拦截的 bean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestBean</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String testStr = <span class="string">"test"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"test"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建 Advisor</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AspectJTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Pointcut</span>(<span class="string">"execution(* *.test(..))"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span>(<span class="string">"test()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"beforeTest"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span>(<span class="string">"test()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"afterTest"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around</span>(<span class="string">"test()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">aroundTest</span><span class="params">(ProceedingJoinPoint p)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"brfore around"</span>);</span><br><span class="line">        Object o = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            o = p.proceed();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"after around"</span>);</span><br><span class="line">        <span class="keyword">return</span> o;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建配置文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:aspectj-autoproxy</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"testBean"</span> <span class="attr">class</span>=<span class="string">"io.github.binglau.bean.TestBean"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"io.github.binglau.AspectJTest"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testAop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ApplicationContext ctx = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"beanFactory.xml"</span>);</span><br><span class="line">    TestBean bean = (TestBean) ctx.getBean(<span class="string">"testBean"</span>);</span><br><span class="line">    bean.test();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>不出意外结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">brfore around</span><br><span class="line">beforeTest</span><br><span class="line">test</span><br><span class="line">after around</span><br><span class="line">afterTest</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>可知 <code>&lt;aop:aspectj-autoproxy /&gt;</code> 是开启 aop 的关键，我们不妨由此入手。</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/12/18/Spring源码分析-AOP/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/18/Kafka生产者分析——KafkaProducer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘冰鉴">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://github.com/BingLau7/blog/blob/master/images/drunktocat.jpg?raw=true">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="村里最好的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/18/Kafka生产者分析——KafkaProducer/" itemprop="url">Kafka生产者分析——KafkaProducer</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-18T22:15:26+08:00">
                2017-12-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/源码分析/" itemprop="url" rel="index">
                    <span itemprop="name">源码分析</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <blockquote>
<p> 文章参考自《Apache  Kafka 源码剖析》</p>
<p> github 地址：<a href="https://github.com/BingLau7/kafka，里面有代码的相关注释" target="_blank" rel="noopener">https://github.com/BingLau7/kafka，里面有代码的相关注释</a></p>
<p> 具体部署方式不进行指导了，网上资料比较多</p>
</blockquote>
<h2 id="KafkaProducer-Demo"><a href="#KafkaProducer-Demo" class="headerlink" title="KafkaProducer Demo"></a>KafkaProducer Demo</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProducerDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> isAsync = args.length == <span class="number">0</span> ||</span><br><span class="line">                <span class="comment">/* 消息的发送方式：异步发送还是同步发送 */</span></span><br><span class="line">                !args[<span class="number">0</span>].trim().equalsIgnoreCase(<span class="string">"sync"</span>);</span><br><span class="line"></span><br><span class="line">        Properties props = <span class="keyword">new</span> Properties();</span><br><span class="line">        props.put(<span class="string">"bootstrap.servers"</span>, <span class="string">"localhost:9092"</span>);</span><br><span class="line">        <span class="comment">/* 客户端的 ID */</span></span><br><span class="line">        props.put(<span class="string">"client.id"</span>, <span class="string">"DemoProducer"</span>);</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * 消息的 key 和 value 都是字节数组，为了将 Java 对象转化为字节数组，可以配置</span></span><br><span class="line"><span class="comment">        * "key.serializer" 和 "value.serializer" 两个序列化器，完成转化</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        props.put(<span class="string">"key.serializer"</span>, <span class="string">"org.apache.kafka.common.serialization.IntegerSerializer"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* StringSerializer 用来将 String 对象序列化成字节数组 */</span></span><br><span class="line">        props.put(<span class="string">"value.serializer"</span>, <span class="string">"org.apache.kafka.common.serialization.StringSerializer"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 生产者的核心类 */</span></span><br><span class="line">        KafkaProducer producer = <span class="keyword">new</span> KafkaProducer&lt;&gt;(props);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 向指定的 test 这个 topic 发送消息 */</span></span><br><span class="line">        String topic = <span class="string">"test"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 消息的 key */</span></span><br><span class="line">        <span class="keyword">int</span> messageNo = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            String messageStr = <span class="string">"Message_"</span> + messageNo;</span><br><span class="line">            <span class="keyword">long</span> startTime = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (isAsync) &#123; <span class="comment">/* 异步发送消息 */</span></span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                *  第一个参数是 ProducerRecord 类型的对象，封装了目标 Topic，消息的 kv</span></span><br><span class="line"><span class="comment">                *  第二个参数是一个 CallBack 对象，当生产者接收到 Kafka 发来的 ACK 确认消息的时候，</span></span><br><span class="line"><span class="comment">                *  会调用此 CallBack 对象的 onCompletion() 方法，实现回调功能</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">                producer.send(<span class="keyword">new</span> ProducerRecord&lt;&gt;(topic, messageNo, messageStr),</span><br><span class="line">                        <span class="keyword">new</span> DemoCallBack(startTime, messageNo, messageStr));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; <span class="comment">/* 同步发送消息 */</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">/*</span></span><br><span class="line"><span class="comment">                    * KafkaProducer.send() 方法的返回值类型是 Future&lt;RecordMetadata&gt;</span></span><br><span class="line"><span class="comment">                    * 这里通过 Future.get 方法，阻塞当前线程，等待 Kafka 服务端的 ACK 响应</span></span><br><span class="line"><span class="comment">                    */</span></span><br><span class="line">                    producer.send(<span class="keyword">new</span> ProducerRecord&lt;&gt;(topic, messageNo, messageStr)).get();</span><br><span class="line">                    System.out.printf(<span class="string">"Send message: (%d, %s)\n"</span>, messageNo, messageStr);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException | ExecutionException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/* 递增消息的 key */</span></span><br><span class="line">            ++messageNo;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DemoCallBack</span> <span class="keyword">implements</span> <span class="title">Callback</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* 开始发送消息的时间戳 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> startTime;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> key;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String message;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DemoCallBack</span><span class="params">(<span class="keyword">long</span> startTime, <span class="keyword">int</span> key, String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.startTime = startTime;</span><br><span class="line">        <span class="keyword">this</span>.key = key;</span><br><span class="line">        <span class="keyword">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生产者成功发送消息，收到 Kafka 服务端发来的 ACK 确认消息后，会调用此回调函数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> metadata 生产者发送的消息的元数据，如果发送过程中出现异常，此参数为 null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> exception 发送过程中出现的异常，如果发送成功为 null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompletion</span><span class="params">(RecordMetadata metadata, Exception exception)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> elapsedTime = System.currentTimeMillis() - startTime;</span><br><span class="line">        <span class="keyword">if</span> (metadata != <span class="keyword">null</span>) &#123;</span><br><span class="line">            System.out.printf(<span class="string">"message: (%d, %s) send to partition %d, offset: %d, in %d\n"</span>,</span><br><span class="line">                    key, message, metadata.partition(), metadata.offset(), elapsedTime);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            exception.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/12/18/Kafka生产者分析——KafkaProducer/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/06/ElasticSearch进阶/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘冰鉴">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://github.com/BingLau7/blog/blob/master/images/drunktocat.jpg?raw=true">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="村里最好的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/06/ElasticSearch进阶/" itemprop="url">ElasticSearch进阶</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-06T10:22:12+08:00">
                2017-12-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/工具/" itemprop="url" rel="index">
                    <span itemprop="name">工具</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h2><h3 id="映射"><a href="#映射" class="headerlink" title="映射"></a>映射</h3><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.0/mapping.html" target="_blank" rel="noopener">官方文档</a></p>
<p>简而言之，映射即为结构（虽然说 ElasticSearch 是一个无模式的搜索引擎）。</p>
<p>定义方式：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT 'localhost:9200/my_index?pretty' -H 'Content-Type: application/json' -d'</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"mappings"</span>: &#123;</span><br><span class="line">    <span class="attr">"doc"</span>: &#123; </span><br><span class="line">      "properties": &#123;  // 字段定义</span><br><span class="line">        "title":    &#123; "type": "text"  &#125;, </span><br><span class="line">        "name":     &#123; "type": "text"  &#125;, </span><br><span class="line">        "age":      &#123; "type": "integer" &#125;,  </span><br><span class="line">        "created":  &#123;</span><br><span class="line">          "type":   "date",   // 类型定义</span><br><span class="line">          "format": "strict_date_optional_time||epoch_millis"</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">'</span><br></pre></td></tr></table></figure>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/12/06/ElasticSearch进阶/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/02/Java-内存模型与线程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘冰鉴">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://github.com/BingLau7/blog/blob/master/images/drunktocat.jpg?raw=true">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="村里最好的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/02/Java-内存模型与线程/" itemprop="url">Java 内存模型与线程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-02T23:28:58+08:00">
                2017-12-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/基础原理/" itemprop="url" rel="index">
                    <span itemprop="name">基础原理</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="预热"><a href="#预热" class="headerlink" title="预热"></a>预热</h2><p>所谓并发的时代，其实不仅仅提现在并发友好的库、框架、语言在兴起，而是这种并发的思想，早已融入到计算机最底层中了。</p>
<p>『让计算机并发执行若干个运算任务』与『更充分地利用计算机处理器的效能』之间的因果关系，看起来顺理成章，实际上它们之间的关系并没有想象中的那么简单，其中一个重要的复杂性来源是绝大多数的<strong>运算任务都不可能只靠处理器『计算』就能完成</strong>，处理器至少要与内存交互，如读取运算数据、存储运算结果等，这个I/O操作是很难消除的（无法仅靠寄存器来完成所有运算任务）。</p>
<p>由于计算机的存储设备与处理器的运算速度有几个数量级的差距，所以现代计算机系统都不得不<strong>加入一层读写速度尽可能接近处理器运算速度的高速缓存（Cache）来作为内存与处理器之间的缓冲</strong>：将运算需要使用到的数据复制到缓存中，让运算能快速进行，当<strong>运算结束后再从缓存同步回内存之中</strong>，这样处理器就无须等待缓慢的内存读写了。</p>
<p>嫌上面文字太长了，<strong>简单说来</strong>就是：计算机计算太快了，等不及慢的主存了，加了 L3、L2、L1 以及寄存器4个高速缓存就是为了让 IO 能快点。</p>
<p>由此产生出了一个问题</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/12/02/Java-内存模型与线程/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/11/26/Spring-源码解析-容器的功能扩展-后续/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘冰鉴">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://github.com/BingLau7/blog/blob/master/images/drunktocat.jpg?raw=true">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="村里最好的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/26/Spring-源码解析-容器的功能扩展-后续/" itemprop="url">Spring 源码解析-容器的功能扩展-后续</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-26T01:19:40+08:00">
                2017-11-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/源码分析/" itemprop="url" rel="index">
                    <span itemprop="name">源码分析</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>本文承接自： <a href="https://binglau7.github.io/2017/11/25/Spring-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-%E5%AE%B9%E5%99%A8%E7%9A%84%E5%8A%9F%E8%83%BD%E6%89%A9%E5%B1%95-BeanFactory%E5%8A%9F%E8%83%BD%E6%89%A9%E5%B1%95/" target="_blank" rel="noopener">Spring-源码解析-容器的功能扩展-BeanFactory功能扩展</a></p>
<p>依照前文继续分析: <code>AbstractApplicationContext#refresh()</code></p>
<h2 id="BeanFactory-的后处理"><a href="#BeanFactory-的后处理" class="headerlink" title="BeanFactory 的后处理"></a>BeanFactory 的后处理</h2><p>BeanFacotry 作为 Spring 中容器功能的基础，用于存放所有已经加载的 bean，为了保证程序上的高可扩展性，Spring 针对 BeanFactory 做了大量的扩展，比如我们熟知的 PostProcessor 等都是在这里实现的。</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/11/26/Spring-源码解析-容器的功能扩展-后续/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/11/25/Spring-源码解析-容器的功能扩展-BeanFactory功能扩展/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘冰鉴">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://github.com/BingLau7/blog/blob/master/images/drunktocat.jpg?raw=true">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="村里最好的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/25/Spring-源码解析-容器的功能扩展-BeanFactory功能扩展/" itemprop="url">Spring-源码解析-容器的功能扩展-BeanFactory功能扩展</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-25T13:39:14+08:00">
                2017-11-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/源码分析/" itemprop="url" rel="index">
                    <span itemprop="name">源码分析</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>之前分析是建立在<code>BeanFactory</code>  接口以及它的实现类 <code>XmlBeanFactory</code> 来进行分析的， <code>ApplicationContext</code> 包含了 <code>BeanFactory</code> 的所有功能，多数情况我们都会使用 <code>ApplicationConetxt</code>。其加载方式如下:</p>
<p><code>ApplicationContext ctx = new ClassPathXmlApplicationContext(&quot;beanFactory.xml&quot;);</code></p>
<p>所以我们就以 <code>ClassPathXmlApplicationContext</code> 来作为分析的切入点：</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/11/25/Spring-源码解析-容器的功能扩展-BeanFactory功能扩展/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/11/23/ElasticSearch基础/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘冰鉴">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://github.com/BingLau7/blog/blob/master/images/drunktocat.jpg?raw=true">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="村里最好的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/23/ElasticSearch基础/" itemprop="url">ElasticSearch基础</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-23T14:09:33+08:00">
                2017-11-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/工具/" itemprop="url" rel="index">
                    <span itemprop="name">工具</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="增删查改范例"><a href="#增删查改范例" class="headerlink" title="增删查改范例"></a>增删查改范例</h2><blockquote>
<p> Restful vs Java API</p>
</blockquote>
<h3 id="Java-API-说明"><a href="#Java-API-说明" class="headerlink" title="Java API 说明"></a>Java API 说明</h3><p>需要添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>transport<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.6.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>需要获取 client 实例:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Settings settings = Settings.EMPTY;</span><br><span class="line">TransportClient client = <span class="keyword">new</span> PreBuiltTransportClient(settings)</span><br><span class="line">        .addTransportAddress(<span class="keyword">new</span> InetSocketTransportAddress(InetAddress.getLocalHost(), <span class="number">9300</span>));</span><br></pre></td></tr></table></figure>
<h3 id="增"><a href="#增" class="headerlink" title="增"></a>增</h3><h4 id="Restful"><a href="#Restful" class="headerlink" title="Restful"></a>Restful</h4><p><code>curl -XPOST &#39;localhost:9200/books/es/1&#39; -d &#39;{&quot;title&quot;: &quot;Elasticsearch Server&quot;, &quot;published&quot;: 2013}&#39;</code></p>
<p>返回：</p>
<p><code>{&quot;_index&quot;:&quot;books&quot;,&quot;_type&quot;:&quot;es&quot;,&quot;_id&quot;:&quot;1&quot;,&quot;_version&quot;:1,&quot;result&quot;:&quot;created&quot;,&quot;_shards&quot;:{&quot;total&quot;:2,&quot;successful&quot;:1,&quot;failed&quot;:0},&quot;created&quot;:true}</code></p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/11/23/ElasticSearch基础/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://github.com/BingLau7/blog/blob/master/images/drunktocat.jpg?raw=true"
               alt="刘冰鉴" />
          <p class="site-author-name" itemprop="name">刘冰鉴</p>
           
              <p class="site-description motion-element" itemprop="description">Res severa est verum gaudium.</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">45</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">7</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">26</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">刘冰鉴</span>
</div>

        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  





  

  

  

  

  

  

</body>
</html>
